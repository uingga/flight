name: Daily Flight Crawl

on:
  schedule:
    # í•˜ë£¨ 7íšŒ (KST): ì˜¤ì „ 2ì‹œê°„, ì˜¤í›„~ì €ë… 3ì‹œê°„ ê°„ê²©, ìì • 00:30
    - cron: '0 23 * * *'     # 08:00 KST
    - cron: '0 1 * * *'      # 10:00 KST
    - cron: '0 3 * * *'      # 12:00 KST
    - cron: '0 6 * * *'      # 15:00 KST
    - cron: '0 9 * * *'      # 18:00 KST
    - cron: '0 12 * * *'     # 21:00 KST
    - cron: '30 15 * * *'    # 00:30 KST
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  crawl:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # ë¦¬í¬ì§€í† ë¦¬ ì»¤ë°‹ ê¶Œí•œ í•„ìš”

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Random delay (0~5ë¶„)
        run: |
          DELAY=$((RANDOM % 300))
          echo "â³ ${DELAY}ì´ˆ ëŒ€ê¸° í›„ í¬ë¡¤ë§ ì‹œì‘..."
          sleep $DELAY

      - name: Run crawler
        id: crawl
        continue-on-error: true
        run: npm run crawl:all
        env:
          CI: true

      - name: Commit and push changes
        if: steps.crawl.outcome == 'success'
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # ë³€ê²½ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [[ -n $(git status --porcelain data/all-flights-cache.json) ]]; then
            git add data/all-flights-cache.json
            git add data/price-history.json 2>/dev/null || true
            git commit -m "chore(data): update flight data [skip ci]"
            git pull --rebase origin main
            git push
            echo "âœ… Data updated and pushed."
          else
            echo "â„¹ï¸ No changes to commit."
          fi

      - name: Alert on failure
        if: steps.crawl.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ í¬ë¡¤ë§ ì‹¤íŒ¨ - ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}`;
            const body = [
              '## í¬ë¡¤ë§ ì‹¤íŒ¨ ì•Œë¦¼',
              '',
              `- **ì‹œê°„**: ${new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })}`,
              `- **Workflow**: ${context.workflow}`,
              `- **Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              '',
              'ìˆ˜ë™ìœ¼ë¡œ í™•ì¸í•´ì£¼ì„¸ìš”: `npm run crawl:all`',
            ].join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['bug', 'automated']
            });
